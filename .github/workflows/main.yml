name: CI via Repository Dispatch (Multi-repo + Static Analysis)

on:
  push:
    branches:
      - main
jobs:
  external-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Clone Repository
        run: |
          git clone https://github.com/${{ github.event.client_payload.repository }} source-code
          ls
          cd source-code
          git checkout ${{ github.event.client_payload.commit_sha }}

      - name: Debug CMakeLists
        run: |
          echo "ğŸ“‚ source-code í´ë” ëª©ë¡"
          ls -al source-code
      
      - name: Set up dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake cppcheck clang-tidy libgtest-dev python3-pip jq gcovr
          sudo snap install gh --classic

      - name: Install Google Test
        run: |
          cd /usr/src/gtest
          sudo cmake .
          sudo make
          sudo cp lib/*.a /usr/lib
          
      - name: Download build-wrapper
        run: |
          curl -sSLo build-wrapper-linux-x86.zip https://sonarcloud.io/static/cpp/build-wrapper-linux-x86.zip
          unzip build-wrapper-linux-x86.zip
  
      - name: Build inside build-wrapper
        run: |
          mkdir build
          cd build
          cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_CXX_FLAGS="--coverage -O0" ../source-code
          ls -al   # Makefile ìƒì„±ëëŠ”ì§€ í™•ì¸
          ../build-wrapper-linux-x86/build-wrapper-linux-x86-64 --out-dir ../bw-output make VERBOSE=1


      - name: Build & Run Tests with Coverage
        run: |
          cd build
          make VERBOSE=1
          ctest --output-on-failure || true

      - name: Generate coverage report (gcovr)
        run: |
          mkdir -p coverage
          gcovr -r source-code \
                --exclude source-code/test \
                --sonarqube \
                -o coverage/coverage.xml

      - name: Show coverage report summary
        run: |
          echo "ğŸ“ˆ coverage.xml ìƒì„± ê²°ê³¼:"
          head -n 20 coverage/coverage.xml || echo "âŒ coverage.xml ì—†ìŒ"

      - name: ğŸ” ì»¤ë²„ë¦¬ì§€ ë””ë²„ê¹…(.gc* íŒŒì¼ ëª©ë¡)
        run: find build -name "*.gc*" || echo "âŒ gcov ê´€ë ¨ íŒŒì¼ ì—†ìŒ"
      
      - name: ğŸ“„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë¡œê·¸ í™•ì¸
        run: cat build/Testing/Temporary/LastTest.log || echo "âŒ í…ŒìŠ¤íŠ¸ ë¡œê·¸ ì—†ìŒ"
        
      
      - name: Debug build artifacts and build-wrapper output
        run: |
          echo "ğŸ“ build ë””ë ‰í† ë¦¬ íŒŒì¼ ëª©ë¡"
          find build -type f || echo "build ë””ë ‰í† ë¦¬ ì—†ìŒ"
      
          echo "ğŸ“ bw-output ë””ë ‰í† ë¦¬ í™•ì¸"
          find bw-output -type f || echo "bw-output ë””ë ‰í† ë¦¬ ì—†ìŒ"


      - name: Run cppcheck
        run: |
          cppcheck --enable=all --inconclusive --std=c++17 --language=c++ \
                   -I source-code/include \
                   source-code/src 2> cppcheck-report.txt
          
      - name: Display cppcheck output
        run: cat cppcheck-report.txt


      - name: Link compile_commands.json
        run: |
          ln -s $(pwd)/build/compile_commands.json source-code/compile_commands.json
          
      - name: Run clang-tidy (with output)
        run: |
          echo "ğŸ” clang-tidy ì‹¤í–‰ ì¤‘"
          mkdir -p clang-tidy-report
          find source-code -name '*.cpp' | while read file; do
            echo "ğŸ§© ê²€ì‚¬ ì¤‘: $file"
            clang-tidy "$file" -p build >> clang-tidy-report/report.txt 2>&1 || true
          done

      - name: Show clang-tidy results
        run: |
          echo "ğŸ“„ clang-tidy ë¶„ì„ ê²°ê³¼:"
          cat clang-tidy-report/report.txt || echo "âŒ ê²°ê³¼ ì—†ìŒ"


      - name: Download sonar-scanner
        run: |
          curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip sonar-scanner.zip
          mv sonar-scanner-* sonar-scanner
  
      - name: Check for sonar-project.properties
        run: |
          echo "ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          echo "ğŸ” ë£¨íŠ¸ì— ìˆëŠ” ì„¤ì •íŒŒì¼ í™•ì¸:"
          ls -al sonar-project.properties || echo "âŒ sonar-project.properties ì—†ìŒ"

      - name: Run SonarCloud scanner manually
        run: |
          sonar-scanner/bin/sonar-scanner \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.coverageReportPaths=coverage/coverage.xml \
            -Dsonar.scm.provider=git \
            -Dsonar.cfamily.compile-commands=build/compile_commands.json
            
      - name: Fetch SonarCloud issues (all types)
        run: |
          curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/issues/search?projectKeys=yoona96_Dev-Sample-Repo&resolved=false&pageSize=500" \
            -o sonar-issues.json

      - name: Create consolidated GitHub issue with Markdown table
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“„ ì´ìŠˆ í…Œì´ë¸” ìƒì„± ì¤‘..."
          
          echo "| ìœ í˜• | ì‹¬ê°ë„ | íŒŒì¼ | ë¼ì¸ | ì„¤ëª… |" > issue-body.md
          echo "|------|--------|------|------|------|" >> issue-body.md

          jq -r '
            .issues[] |
            "| \(.type) | \(.severity) | \(.component | sub(".*src/"; "")) | \(.line // "N/A") | \(.message | gsub("[\r\n]"; " ")) |"
          ' sonar-issues.json >> issue-body.md

          issue_count=$(cat issue-body.md | wc -l)
          echo "ğŸ”¢ ì´ ì´ìŠˆ ìˆ˜: $((issue_count - 2))"

          if [[ $issue_count -gt 2 ]]; then
            gh issue create \
              --title "ğŸ“Š SonarCloud ì •ì  ë¶„ì„ ìš”ì•½ ë³´ê³ ì„œ" \
              --body "$(cat issue-body.md)"
          else
            echo "âœ… ì´ìŠˆê°€ ì—†ìœ¼ë¯€ë¡œ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi

      - name: Print all SonarCloud issues to console
        run: |
          echo "ğŸ“‹ SonarCloud ì´ìŠˆ ëª©ë¡ (ëª¨ë“  ì‹¬ê°ë„, ëª¨ë“  ìœ í˜•)"
          jq -r '
            .issues[] |
            "[\(.severity)] [\(.type)] \(.message)\n  â†ª File: \(.component | sub(".*src/"; "")) | Line: \(.line // "N/A") | Key: \(.key)\n"
          ' sonar-issues.json
